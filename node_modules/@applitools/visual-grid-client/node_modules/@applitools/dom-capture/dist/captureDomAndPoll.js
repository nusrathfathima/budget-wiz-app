/* @applitools/dom-capture@7.3.0 */

function __captureDomAndPoll() {
  var captureDomAndPoll=function(){"use strict";var e={styleProps:["background-repeat","background-origin","background-position","background-color","background-image","background-size","border-width","border-color","border-style","color","display","font-size","font-weight","line-height","margin","opacity","overflow","padding","visibility"],rectProps:["width","height","top","left"],ignoredTagNames:["HEAD","SCRIPT"]};const t=/url\((?!['"]?:)['"]?([^'")]*)['"]?\)/;var n=function(e){const n=e?e.match(t):void 0;return n?n[1]:n};var o=async function({bgImages:e,timeout:t=5e3,Image:n=window.Image}){return(await Promise.all(Array.from(e).map(e=>{return Promise.race([new Promise(t=>{const o=new n;o.onload=()=>t({url:e,width:o.naturalWidth,height:o.naturalHeight}),o.onerror=()=>t(),o.src=e}),(o=t,new Promise(e=>{setTimeout(e,o)}))]);var o}))).reduce((e,t)=>(t&&(e[t.url]={width:t.width,height:t.height}),e),{})};function r(e){return Array.prototype.filter.call(e.parentNode.childNodes,t=>t.tagName===e.tagName).indexOf(e)+1}var s=function e(t){if(!t.ownerDocument)return"";let n="",o=t,s=t.ownerDocument,a=s.defaultView.frameElement;for(;o!==s;)n=`${o.tagName}[${r(o)}]/${n}`,o=o.parentNode;return a&&(n=`${e(a)},${n}`),n.replace(/\/$/,"")};var a=function(e){return!/^https?:.+/.test(e.src)||e.contentDocument&&e.contentDocument.location&&["about:blank","about:srcdoc"].includes(e.contentDocument.location.href)};var c=function(e,t){return new URL(e,t).href};var i=function({parseCss:e,CSSImportRule:t,absolutizeUrl:n,getCssFromCache:o,unfetchedToken:r}){return function s(a,c){let i,u="";try{const l=e(a);for(const e of Array.from(l.cssRules))if(e instanceof t){const t=n(e.href,c),a=o(t);if(void 0!==a){const{bundledCss:e,unfetchedResources:n}=s(a,t);n&&(i=new Set(n)),u=`${e}${u}`}else i=new Set([t]),u=`\n${r}${t}${r}`}}catch(e){console.log("error during getBundledCssFromCssText, styleBaseUrl="+c,e)}var l,d;return u=`${u}${l=a,d=c,`\n/** ${d} **/\n${l}`}`,{bundledCss:u,unfetchedResources:i}}};var u=function(e){var t=document.implementation.createHTMLDocument(""),n=t.createElement("style");return n.textContent=e,t.body.appendChild(n),n.sheet};var l=function(e,{fetchTimeLimit:t}={}){return async function(n){const o=new AbortController,r=[e(n,{cache:"force-cache",signal:o.signal}).then(e=>{if(e.ok)return e.text();console.log("/failed to fetch (status "+e.status+") css from: "+n+"/")}).catch(e=>{console.log("/failed to fetch (error "+e.toString()+") css from: "+n+"/")})];return Number.isNaN(Number(t))||r.push(new Promise(e=>setTimeout(e,t)).then(()=>o.abort())),Promise.race(r)}},d=function(e){const t=Array.from(e.attributes).find(e=>"href"===e.name.toLowerCase());return t&&t.value},f=function(e){if(e.nodeName&&"LINK"===e.nodeName.toUpperCase()&&e.attributes){const t=new Map(Array.from(e.attributes,e=>[e.name.toLowerCase(),e.value.toLowerCase()]));return"stylesheet"===t.get("rel")||"style"===t.get("as")&&["preload","prefetch"].includes(t.get("rel"))}return!1};var m=function(e){return e&&e.startsWith("data:")};var h=function({getCssFromCache:e,absolutizeUrl:t}){return function(n,o){let r,s,a;if(function(e){return e.nodeName&&"STYLE"===e.nodeName.toUpperCase()}(n))r=Array.from(n.childNodes).map(e=>e.nodeValue).join(""),s=o;else if(f(n)){const c=d(n);m(c)?(s=o,r=c.match(/,(.+)/)[1]):(s=t(c,o),r=e(s)),a=void 0===r}return{cssText:r,styleBaseUrl:s,isUnfetched:a}}};var g=function({extractCssFromNode:e,getBundledCssFromCssText:t,unfetchedToken:n}){return function(o,r){const{styleBaseUrl:s,cssText:a,isUnfetched:c}=e(o,r);let i,u="";if(a){const{bundledCss:e,unfetchedResources:n}=t(a,s);u+=e,i=new Set(n)}else c&&(u+=`${n}${s}${n}`,i=new Set([s]));return{bundledCss:u,unfetchedResources:i}}};var p={NODE_TYPES:{ELEMENT:1,TEXT:3,DOCUMENT_FRAGMENT:11}};const{NODE_TYPES:w}=p;var y=function(e){return async function(t=document){const n={},o=Date.now(),r=[];return function t(n,o,r,s){function i(t){switch(s.push(async function(t,n,o){let r,s;f(t)&&(s=c(d(t),n),r=await e(s),void 0!==r&&(o[s]=r));r&&await async function t(n,o,r){try{const s=u(n),a=[];for(const n of Array.from(s.cssRules))n instanceof CSSImportRule&&a.push((async()=>{const s=c(n.href,o),a=await e(s);r[s]=a,void 0!==a&&await t(a,s,r)})());await Promise.all(a)}catch(e){console.log("error during fetchBundledCss, resourceUrl="+o,e)}}(r,s,o)}(t,o,r)),t.nodeType){case w.ELEMENT:return"IFRAME"===t.tagName.toUpperCase()?m(t):l(t)}}async function l(e){Array.prototype.map.call(e.childNodes,i)}async function m(e){if(l(e),e.contentDocument)try{const n=a(e)?e.baseURI:e.contentDocument.location.href;t(e.contentDocument,n,r,s)}catch(e){console.log(e)}}i(n.documentElement)}(t,t.location.href,n,r),await Promise.all(r),console.log("[prefetchAllCss]",Date.now()-o),function(e){return n[e]}}};const{NODE_TYPES:C}=p;var _=async function({styleProps:t,rectProps:r,ignoredTagNames:d}=e,f=document,m=!1,p=3e4){const w={total:{},prefetchCss:{},doCaptureDoc:{},waitForImages:{}};function _(e){e.startTime=Date.now()}function S(e){e.endTime=Date.now(),e.elapsedTime=e.endTime-e.startTime}const E=[];_(w.total);const T=new Set,N=[];_(w.prefetchCss);const b=y(l(fetch,{fetchTimeLimit:p})),P=await b(f);S(w.prefetchCss);const v=i({parseCss:u,CSSImportRule:CSSImportRule,getCssFromCache:P,absolutizeUrl:c,unfetchedToken:"#####"}),O=h({getCssFromCache:P,absolutizeUrl:c}),R=g({extractCssFromNode:O,getBundledCssFromCssText:v,unfetchedToken:"#####"});_(w.doCaptureDoc);const D=function e(c,i=c.location&&c.location.href){const u=new Set;let l="";const f=m(c.documentElement||c);return f.css=l,E.push(o({bgImages:u}).then(e=>f.images=e)),f;function m(e){const{bundledCss:t,unfetchedResources:n}=R(e,i);if(l+=t,n)for(const e of n)T.add(e);switch(e.nodeType){case C.TEXT:return function(e){return{tagName:"#text",text:e.textContent}}(e);case C.ELEMENT:return"IFRAME"===e.tagName.toUpperCase()?g(e):h(e);case C.DOCUMENT_FRAGMENT:return{childNodes:Array.prototype.map.call(e.childNodes,m).filter(Boolean)};default:return null}}function h(o){const s=Array.prototype.map.call(o.childNodes,m).filter(Boolean),a=o.shadowRoot&&e(o.shadowRoot,i),c=o.tagName.toUpperCase();if(d.indexOf(c)>-1)return null;const l=window.getComputedStyle(o),f=o.getBoundingClientRect(),h={};for(const e of t)h[e]=l.getPropertyValue(e);h["border-width"]||(h["border-width"]=`${l.getPropertyValue("border-top-width")} ${l.getPropertyValue("border-right-width")} ${l.getPropertyValue("border-bottom-width")} ${l.getPropertyValue("border-left-width")}`);const g={};for(const e of r)g[e]=f[e];const p=Array.from(o.attributes).map(e=>({key:e.name,value:e.value})).reduce((e,t)=>(e[t.key]=t.value,e),{}),w=n(l.getPropertyValue("background-image"));w&&u.add(w);const y={tagName:c,style:k(h),rect:k(g),attributes:k(p),childNodes:s};return a&&(y.shadowRoot=a),y}function g(t){const n=h(t);let o;try{o=t.contentDocument}catch(e){return r(),n}try{o?n.childNodes=[e(o,a(t)?t.baseURI:o.location.href)]:r()}catch(e){console.log("error in iframeToJSON",e)}return n;function r(){const e=s(t);N.push(e),n.childNodes=[`@@@@@${e}@@@@@`]}}}(f);S(w.doCaptureDoc),_(w.waitForImages),await Promise.all(E),S(w.waitForImages),D.version="1.3.0",D.scriptVersion="7.3.0";const I=N.length?N.join("\n")+"\n":"",L=T.size?Array.from(T).join("\n")+"\n":"",A=JSON.stringify({separator:"-----",cssStartToken:"#####",cssEndToken:"#####",iframeStartToken:'"@@@@@',iframeEndToken:'@@@@@"'});S(w.total);const $=`${A}\n${L}-----\n${I}-----\n${JSON.stringify(D)}${m?"\n-----\n"+JSON.stringify(w):""}`;return console.log("[captureFrame]",JSON.stringify(w)),$;function k(e){return Object.keys(e).length?e:void 0}};const S="WIP",E="SUCCESS",T="SUCCESS_CHUNKED",N="ERROR";var b=function(e){const t=function(e,{maxChunkSize:t=0}={}){if(e){if(e.value){if(t&&(e.stringified||(e.stringified=JSON.stringify(e.value)),e.stringified.length>t)){const n=e.nextChunkIndex||0;return e.nextChunkIndex=n+t,{status:T,value:e.stringified.substring(n,e.nextChunkIndex),done:e.nextChunkIndex>=e.stringified.length}}return{status:E,value:e.value}}return e.error?{status:N,error:e.error}:{status:S}}return{status:N,error:"unexpected poll request received - cannot find state of current operation"}}(window.__EYES__APPLITOOLS__?window.__EYES__APPLITOOLS__.captureDomResult:null,e);return(t.status===E||t.status===N||t.status===T&&t.done)&&(window.__EYES__APPLITOOLS__.captureDomResult=null),JSON.stringify(t)};return function(...e){return window.__EYES__APPLITOOLS__||(window.__EYES__APPLITOOLS__={}),window.__EYES__APPLITOOLS__.captureDomResult||(window.__EYES__APPLITOOLS__.captureDomResult={},_(...e).then(e=>window.__EYES__APPLITOOLS__.captureDomResult.value=e).catch(e=>window.__EYES__APPLITOOLS__.captureDomResult.error=e.message)),b(e[4])}}();

  return captureDomAndPoll.apply(this, arguments);
}